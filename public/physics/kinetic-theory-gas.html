<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>溫度與氣體粒子活動 - 國中自然科學模擬動畫</title>
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Modular CSS -->
    <link rel="stylesheet" href="../assets/css/common.css">
    <link rel="stylesheet" href="../assets/css/accessibility.css">
</head>
<body>
    <a href="#main" class="skip-link">跳到主內容</a>
    
    <!-- Navbar Container -->
    <div id="navbarContainer"></div>

        <main id="main" class="container my-4" tabindex="-1">
            <div class="row g-4">
                <div class="col-12 col-lg-8">
                    <div class="card h-100">
                        <div class="card-body">
                            <h1 class="h3 card-title mb-3"><i class="fa-solid fa-wind" aria-hidden="true"></i> 溫度與氣體粒子活動</h1>
                            <p class="card-text mb-3">觀察理想氣體在封閉容器中的粒子運動：溫度越高，平均動能越大，運動越快速。</p>
                            <div id="statusRegion" class="visually-hidden" aria-live="polite" aria-atomic="true">初始化中</div>
                            <div class="canvas-container border border-2 border-secondary-subtle">
                                <canvas id="simCanvas" role="img" aria-label="氣體粒子運動模擬"></canvas>
                                <div class="position-absolute top-0 end-0 m-2 bg-white bg-opacity-75 rounded px-2 py-1 border small"><span id="tempValueDisplay" class="fw-bold text-danger">25</span> °C</div>
                            </div>
                            <p class="small text-muted mt-2 mb-0"><i class="fa-solid fa-circle-info" aria-hidden="true"></i> 模擬環境：封閉容器內的理想氣體粒子。</p>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <h2 class="h5 card-title mb-3">控制面板</h2>
                            <div class="mb-3">
                                <label for="tempSlider" class="form-label fw-semibold d-flex justify-content-between align-items-center">調整溫度 <span id="tempStateText" class="badge text-bg-primary">常溫</span></label>
                                <input type="range" id="tempSlider" class="form-range" min="-273" max="500" value="25" step="1" aria-valuemin="-273" aria-valuemax="500" aria-valuenow="25" aria-label="調整溫度">
                                <div class="d-flex justify-content-between small text-secondary"><span>-273°C (絕對零度)</span><span>500°C</span></div>
                            </div>
                            <div class="d-grid gap-2 mb-3">
                                <button id="resetBtn" class="btn btn-outline-secondary" type="button"><i class="fa-solid fa-rotate-right" aria-hidden="true"></i> 重置</button>
                                <button id="pauseBtn" class="btn btn-primary" type="button" aria-pressed="false"><i class="fa-solid fa-pause" aria-hidden="true"></i> 暫停</button>
                            </div>
                            <button class="btn btn-outline-info btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#shortcutHelp" aria-expanded="false" aria-controls="shortcutHelp"><i class="fa-solid fa-keyboard" aria-hidden="true"></i> 快捷鍵說明</button>
                            <div id="shortcutHelp" class="collapse mt-2">
                                <div class="card card-body small"><ul class="mb-0" aria-label="快捷鍵清單"><li><kbd>Space</kbd>：暫停/繼續</li><li><kbd>R</kbd>：重置</li><li><kbd>← / →</kbd>：溫度 ±10°C</li></ul></div>
                            </div>
                            <div class="accordion mt-3" id="theoryAccordion">
                                <div class="accordion-item">
                                    <h3 class="accordion-header" id="headingTheory"><button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelTheory" aria-expanded="false" aria-controls="panelTheory">微觀解釋</button></h3>
                                    <div id="panelTheory" class="accordion-collapse collapse" aria-labelledby="headingTheory" data-bs-parent="#theoryAccordion"><div class="accordion-body small">溫度反映粒子的平均動能。理想氣體中，粒子作隨機直線運動並與器壁彈性碰撞，溫度愈高，速率分布峰值右移。</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

    <!-- Footer Container -->
    <div id="footerContainer"></div>

        <!-- Bootstrap JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        
        <!-- ES Module: Load Navigation & Theme -->
        <script type="module">
            import { initThemeToggle } from '../assets/js/theme.js';
            import { loadNavigation } from '../assets/js/navigation.js';
            import { createLiveRegion, KeyboardManager } from '../assets/js/a11y.js';

            // 載入導覽和頁尾
            await loadNavigation({
                baseUrl: '..',
                navbarPath: '../assets/templates/navbar.html',
                footerPath: '../assets/templates/footer.html'
            });

            // 初始化主題切換
            initThemeToggle();

            // 建立 Live Region
            window.liveRegion = createLiveRegion({ id: 'simLiveRegion', throttle: 300 });

            // 鍵盤快捷鍵
            const keyboardManager = new KeyboardManager();
            keyboardManager.register(' ', () => {
                document.getElementById('pauseBtn').click();
            }, { description: '暫停/繼續' });
            keyboardManager.register('r', () => {
                document.getElementById('resetBtn').click();
            }, { description: '重置' });
            keyboardManager.register('ArrowLeft', () => {
                const slider = document.getElementById('tempSlider');
                slider.value = Math.max(-273, parseInt(slider.value) - 10);
                slider.dispatchEvent(new Event('input'));
            }, { description: '降低溫度' });
            keyboardManager.register('ArrowRight', () => {
                const slider = document.getElementById('tempSlider');
                slider.value = Math.min(500, parseInt(slider.value) + 10);
                slider.dispatchEvent(new Event('input'));
            }, { description: '升高溫度' });
        </script>
        
        <!-- Page-Specific Simulation Logic -->
        <script>
        // === 氣體粒子模擬邏輯 ===
        const canvas = document.getElementById('simCanvas');
        const ctx = canvas.getContext('2d');
        const slider = document.getElementById('tempSlider');
        const resetBtn = document.getElementById('resetBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const tempValueDisplay = document.getElementById('tempValueDisplay');
        const tempStateText = document.getElementById('tempStateText');
        
        // 粒子設定
        const particleCount = 60;
        const particleRadius = 6;
        let particles = [];
        let temperature = 25; // 攝氏溫度
        let animationId;
        let paused = false;

        // 公開函數供模組調用
        window.updateTemperature = function(temp) {
            temperature = temp;
            tempValueDisplay.textContent = temperature;
            updateUIState(temperature);
        };

        // --- 初始化 Canvas 大小 ---
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // --- 粒子類別 ---
        class Particle {
            constructor() {
                this.x = Math.random() * (canvas.width - particleRadius * 2) + particleRadius;
                this.y = Math.random() * (canvas.height - particleRadius * 2) + particleRadius;
                
                // 基礎向量 (方向)
                const angle = Math.random() * Math.PI * 2;
                this.vx = Math.cos(angle);
                this.vy = Math.sin(angle);
                
                // 每個粒子有微小的速度差異，讓畫面更自然
                this.speedVar = 0.8 + Math.random() * 0.4; 
            }

            update(speedFactor) {
                // 如果是絕對零度 (-273)，停止運動
                if (temperature <= -273) {
                    return; 
                }

                // 更新位置：基礎向量 * 速度因子 * 個體差異
                this.x += this.vx * speedFactor * this.speedVar;
                this.y += this.vy * speedFactor * this.speedVar;

                // 碰到牆壁反彈
                if (this.x + particleRadius > canvas.width) {
                    this.x = canvas.width - particleRadius;
                    this.vx *= -1;
                } else if (this.x - particleRadius < 0) {
                    this.x = particleRadius;
                    this.vx *= -1;
                }

                if (this.y + particleRadius > canvas.height) {
                    this.y = canvas.height - particleRadius;
                    this.vy *= -1;
                } else if (this.y - particleRadius < 0) {
                    this.y = particleRadius;
                    this.vy *= -1;
                }
            }

            draw(color) {
                ctx.beginPath();
                ctx.arc(this.x, this.y, particleRadius, 0, Math.PI * 2);
                ctx.fillStyle = color;
                ctx.fill();
                // 添加一點光澤感
                ctx.strokeStyle = "rgba(0,0,0,0.1)";
                ctx.stroke();
                ctx.closePath();
            }
        }

        // --- 初始化粒子 ---
        function initParticles() {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        // --- 輔助功能：顏色與速度計算 ---
        
        // 根據溫度計算速度因子 (Kelvin 溫度與動能成正比，速度與根號 T 成正比)
        // 為了模擬效果明顯，我們做了一些線性調整
        function getSpeedFactor(tempC) {
            // 將攝氏轉為凱氏絕對溫標概念 (近似)
            // -273度時速度為0
            const minTemp = -273;
            const maxTemp = 500;
            const normalized = (tempC - minTemp) / (maxTemp - minTemp); // 0 到 1
            
            if (tempC <= -273) return 0;

            // 速度基數：最低 0，最高 12 (像素/幀)
            return normalized * 10; 
        }

        // 根據溫度計算顏色 (藍 -> 紫 -> 紅 -> 黃)
        function getColor(tempC) {
            if (tempC <= -273) return 'rgb(50, 50, 100)'; // 凍結暗藍色

            // 簡單的線性插值
            let r, g, b;
            
            if (tempC < 0) {
                // 冰冷藍
                r = 0; g = 100; b = 255;
            } else if (tempC < 100) {
                // 常溫過渡 (藍 -> 紅)
                const t = tempC / 100; 
                r = Math.floor(255 * t);
                g = Math.floor(100 * (1-t));
                b = Math.floor(255 * (1-t));
            } else {
                // 高溫 (紅 -> 黃/白)
                const t = (tempC - 100) / 400; // 0 to 1
                r = 255;
                g = Math.floor(255 * t); // 變黃
                b = 0;
            }
            return `rgb(${r}, ${g}, ${b})`;
        }

        function updateUIState(temp) {
            let text = "";
            let badgeClass = "badge ";

            if (temp <= -273) {
                text = "絕對零度 (粒子停止)";
                badgeClass += "text-bg-secondary";
            } else if (temp < 0) {
                text = "低溫 (凝固/緩慢)";
                badgeClass += "text-bg-info";
            } else if (temp < 100) {
                text = "常溫/液態";
                badgeClass += "text-bg-success";
            } else {
                text = "高溫 (激動/氣態)";
                badgeClass += "text-bg-danger";
            }
            
            tempStateText.textContent = text;
            tempStateText.className = badgeClass;
        }

        // --- 動畫主迴圈 ---
        function animate() {
            // 清除畫布，並留下淡淡的殘影軌跡 (選用，目前使用全清讓畫面較乾淨)
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            // ctx.fillRect(0, 0, canvas.width, canvas.height);

            const speedFactor = getSpeedFactor(temperature);
            const color = getColor(temperature);

            particles.forEach(p => {
                p.update(speedFactor);
                p.draw(color);
            });

            // 處理簡單的粒子間碰撞 (視覺效果用，非嚴格物理碰撞)
            // 為了效能和避免過度複雜，這裡使用簡單的距離檢查
            // 兩兩檢查 (O(n^2) 對於 60 個粒子是可以接受的)
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const p1 = particles[i];
                    const p2 = particles[j];
                    const dx = p1.x - p2.x;
                    const dy = p1.y - p2.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < particleRadius * 2) {
                        // 簡單的彈性碰撞邏輯：交換速度向量
                        // 這種簡化讓模擬看起來很有活力，雖然不是完美的物理引擎
                        let tempVx = p1.vx;
                        let tempVy = p1.vy;
                        p1.vx = p2.vx;
                        p1.vy = p2.vy;
                        p2.vx = tempVx;
                        p2.vy = tempVy;

                        // 防止重疊卡住：稍微推開
                        const overlap = particleRadius * 2 - distance;
                        const angle = Math.atan2(dy, dx);
                        p1.x += Math.cos(angle) * overlap / 2;
                        p1.y += Math.sin(angle) * overlap / 2;
                        p2.x -= Math.cos(angle) * overlap / 2;
                        p2.y -= Math.sin(angle) * overlap / 2;
                    }
                }
            }

            if(!paused){ animationId = requestAnimationFrame(animate); }
        }

        // --- 事件監聽 ---
        slider.addEventListener('input', (e) => {
            temperature = parseInt(e.target.value);
            tempValueDisplay.textContent = temperature;
            slider.setAttribute('aria-valuenow', String(temperature));
            updateUIState(temperature);
            if (window.liveRegion) {
                window.liveRegion.announce(`溫度設定為 ${temperature} 度`);
            }
        });

        // 暫停/繼續
        pauseBtn.addEventListener('click', ()=>{
            paused = !paused;
            pauseBtn.setAttribute('aria-pressed', paused);
            if(paused){
                pauseBtn.classList.remove('btn-primary');
                pauseBtn.classList.add('btn-warning');
                pauseBtn.innerHTML = '<i class="fa-solid fa-play" aria-hidden="true"></i> 繼續';
                if (window.liveRegion) window.liveRegion.announce('動畫已暫停');
            }else{
                pauseBtn.classList.remove('btn-warning');
                pauseBtn.classList.add('btn-primary');
                pauseBtn.innerHTML = '<i class="fa-solid fa-pause" aria-hidden="true"></i> 暫停';
                if (window.liveRegion) window.liveRegion.announce('動畫已繼續');
                requestAnimationFrame(animate);
            }
        });

        // 重置
        function reset(){
            temperature = 25;
            slider.value = '25';
            slider.setAttribute('aria-valuenow','25');
            tempValueDisplay.textContent = '25';
            updateUIState(temperature);
            if (window.liveRegion) window.liveRegion.announce('已重置為常溫 25 度');
            initParticles();
        }
        resetBtn.addEventListener('click', reset);

        // 啟動
        initParticles();
        animate();
        updateUIState(temperature);
        if (window.liveRegion) {
            window.liveRegion.announce('溫度與氣體粒子活動模擬已載入');
        }
    </script>
</body>
</html>