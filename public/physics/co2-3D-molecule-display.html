<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D åˆ†å­æ¨¡å‹æª¢è¦–å™¨ (CO2, H2O, NaCl)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: "Noto Sans TC", sans-serif;
            color: white;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 250px;
        }

        h1 {
            margin: 0 0 5px 0;
            font-size: 1.4rem;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        h2 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #aaaaaa;
            font-weight: normal;
        }

        p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #cccccc;
            line-height: 1.4;
        }

        .legend {
            display: flex;
            align-items: center;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }

        /* é¡è‰²å®šç¾© */
        .dot.carbon { background-color: #333333; border: 1px solid #555; }
        .dot.oxygen { background-color: #ff3333; border: 1px solid #ff6666; }
        .dot.hydrogen { background-color: #eeeeee; border: 1px solid #999; } /* ç™½è‰² H */
        .dot.sodium { background-color: #673AB7; border: 1px solid #9575cd; } /* ç´«è‰² Na */
        .dot.chlorine { background-color: #2E7D32; border: 1px solid #66bb6a; } /* ç¶ è‰² Cl */

        /* æŒ‰éˆ•å€åŸŸ */
        #controls-area {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            font-family: "Noto Sans TC", sans-serif;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        button.active {
            background: #2196F3;
            border-color: #64b5f6;
            box-shadow: 0 0 15px rgba(33, 150, 243, 0.4);
        }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.85rem;
            user-select: none;
        }

        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: white;
            display: none;
        }

        #error-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            color: #ff6666;
            text-align: center;
            display: none;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <!-- å·¦ä¸Šè§’è³‡è¨Šé¢æ¿ (å‹•æ…‹æ›´æ–°) -->
    <div id="ui-layer">
        <h1 id="model-title">COâ‚‚ äºŒæ°§åŒ–ç¢³</h1>
        <h2 id="model-subtitle">Linear Structure</h2>
        <div id="legend-container">
            <!-- é€™è£¡çš„å…§å®¹æœƒç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
        </div>
        <p id="model-desc" style="margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px;">
            è¼‰å…¥ä¸­...
        </p>
    </div>

    <!-- å³ä¸Šè§’åˆ‡æ›æŒ‰éˆ• -->
    <div id="controls-area">
        <button id="btn-co2" class="active" onclick="switchModel('co2')">COâ‚‚</button>
        <button id="btn-h2o" onclick="switchModel('h2o')">Hâ‚‚O</button>
        <button id="btn-nacl" onclick="switchModel('nacl')">NaCl</button>
    </div>

    <div class="controls-hint">
        ğŸ–±ï¸ æ‹–æ›³æ—‹è½‰ | æ»¾è¼ªç¸®æ”¾ | å³éµå¹³ç§»
    </div>

    <div id="loader">æ¨¡å‹åˆ‡æ›ä¸­...</div>
    <div id="error-msg"></div>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // å…¨åŸŸè®Šæ•¸
        let scene, camera, renderer, controls;
        let moleculeGroup; // ç”¨ä¾†æ”¾ç•¶å‰çš„åˆ†å­æ¨¡å‹
        
        // åˆå§‹åŒ– 3D ç’°å¢ƒ
        function init() {
            const container = document.getElementById('canvas-container');

            // 1. Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            scene.fog = new THREE.Fog(0x1a1a1a, 10, 60);

            // 2. Camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 14);

            // 3. Renderer (åŒ…å« WebGL 1 fallback)
            try {
                const canvas = document.createElement('canvas');
                container.appendChild(canvas);
                const contextAttributes = { alpha: true, antialias: true };
                const context = canvas.getContext('webgl', contextAttributes) || canvas.getContext('experimental-webgl', contextAttributes);

                if (!context) throw new Error("ç„¡æ³•å»ºç«‹ WebGL Context");

                renderer = new THREE.WebGLRenderer({ canvas: canvas, context: context, antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;

            } catch (e) {
                console.error(e);
                document.getElementById('error-msg').style.display = 'block';
                document.getElementById('error-msg').innerHTML = "ç„¡æ³•å•Ÿå‹• 3D å¼•æ“: " + e.message;
                return;
            }

            // 4. Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xffffff, 1.2);
            mainLight.position.set(5, 10, 7);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 1024;
            mainLight.shadow.mapSize.height = 1024;
            scene.add(mainLight);

            const fillLight = new THREE.PointLight(0x66ccff, 0.4);
            fillLight.position.set(-10, -5, -5);
            scene.add(fillLight);

            // 5. Controls
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // 6. Group Setup
            moleculeGroup = new THREE.Group();
            scene.add(moleculeGroup);

            // Resize Event
            window.addEventListener('resize', onWindowResize);

            // Start Animation
            animate();

            // é è¨­è¼‰å…¥ CO2
            loadCO2();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) renderer.render(scene, camera);
        }

        // æ¸…é™¤ç›®å‰çš„å ´æ™¯ç‰©ä»¶
        function clearScene() {
            while(moleculeGroup.children.length > 0){ 
                const object = moleculeGroup.children[0];
                if(object.geometry) object.geometry.dispose();
                if(object.material) object.material.dispose();
                moleculeGroup.remove(object); 
            }
            // é‡ç½®ä½ç½®èˆ‡æ—‹è½‰
            moleculeGroup.rotation.set(0, 0, 0);
            moleculeGroup.position.set(0, 0, 0);
        }

        // ==========================================
        // æ¨¡å‹å»ºæ§‹é‚è¼¯
        // ==========================================

        // å…±ç”¨æè³ª
        const materials = {
            carbon: new THREE.MeshPhysicalMaterial({ color: 0x222222, roughness: 0.3, metalness: 0.2, clearcoat: 0.8 }),
            oxygen: new THREE.MeshPhysicalMaterial({ color: 0xe60000, roughness: 0.3, metalness: 0.1, clearcoat: 0.5 }),
            hydrogen: new THREE.MeshPhysicalMaterial({ color: 0xffffff, roughness: 0.2, metalness: 0.1, clearcoat: 0.3 }), // ç™½è‰² H
            sodium: new THREE.MeshPhysicalMaterial({ color: 0x673AB7, roughness: 0.2, metalness: 0.3, clearcoat: 0.6 }), // ç´«è‰²
            chlorine: new THREE.MeshPhysicalMaterial({ color: 0x2E7D32, roughness: 0.4, metalness: 0.1, clearcoat: 0.3 }), // ç¶ è‰²
            bond: new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.4, metalness: 0.3 })
        };

        // --- 1. CO2 æ¨¡å‹ ---
        window.loadCO2 = function() {
            clearScene();
            
            // UI æ›´æ–°
            updateUI(
                "COâ‚‚ äºŒæ°§åŒ–ç¢³", 
                "ç·šæ€§åˆ†å­ (Linear)", 
                `
                <div class="legend"><span class="dot carbon"></span> ç¢³ (Carbon)</div>
                <div class="legend"><span class="dot oxygen"></span> æ°§ (Oxygen)</div>
                `,
                "éµè§’: 180Â°<br>çµæ§‹: O = C = O<br>å…©å€‹æ°§åŸå­é€éé›™éµèˆ‡ä¸­å¿ƒç¢³åŸå­é€£æ¥ï¼Œå‘ˆç¾ç›´ç·šçµæ§‹ã€‚"
            );

            const carbonRadius = 1.3;
            const oxygenRadius = 1.0;
            const bondLength = 3.2;
            const bondRadius = 0.12;
            const bondOffset = 0.3;

            // ç¢³åŸå­
            const carbon = new THREE.Mesh(new THREE.SphereGeometry(carbonRadius, 32, 32), materials.carbon);
            carbon.castShadow = true;
            moleculeGroup.add(carbon);

            // å»ºç«‹å…©å´
            [-1, 1].forEach(dir => {
                const xPos = dir * bondLength;

                // æ°§åŸå­
                const oxygen = new THREE.Mesh(new THREE.SphereGeometry(oxygenRadius, 32, 32), materials.oxygen);
                oxygen.position.set(xPos, 0, 0);
                oxygen.castShadow = true;
                moleculeGroup.add(oxygen);

                // é›™éµ (ä¸Š)
                const bondTop = new THREE.Mesh(new THREE.CylinderGeometry(bondRadius, bondRadius, bondLength, 16), materials.bond);
                bondTop.rotation.z = Math.PI / 2;
                bondTop.position.set(xPos / 2, bondOffset, 0);
                bondTop.castShadow = true;
                moleculeGroup.add(bondTop);

                // é›™éµ (ä¸‹)
                const bondBot = new THREE.Mesh(new THREE.CylinderGeometry(bondRadius, bondRadius, bondLength, 16), materials.bond);
                bondBot.rotation.z = Math.PI / 2;
                bondBot.position.set(xPos / 2, -bondOffset, 0);
                bondBot.castShadow = true;
                moleculeGroup.add(bondBot);
            });
            
            controls.reset();
            camera.position.set(0, 2, 12);
        };

        // --- 2. H2O æ¨¡å‹ (æ–°å¢) ---
        window.loadH2O = function() {
            clearScene();

            // UI æ›´æ–°
            updateUI(
                "Hâ‚‚O æ°´åˆ†å­", 
                "å½æ›²çµæ§‹ (Bent)", 
                `
                <div class="legend"><span class="dot oxygen"></span> æ°§ (Oxygen)</div>
                <div class="legend"><span class="dot hydrogen"></span> æ°« (Hydrogen)</div>
                `,
                "éµè§’: ~104.5Â°<br>çµæ§‹: H - O - H<br>ç”±æ–¼æ°§åŸå­ä¸Šæœ‰å…©å°å­¤å°é›»å­ï¼Œä½¿å¾—åˆ†å­å‘ˆç¾Vå‹å½æ›²ã€‚"
            );

            const oxygenRadius = 1.2;
            const hydrogenRadius = 0.8;
            const bondLength = 2.8;
            const bondRadius = 0.12;
            
            // è¨ˆç®—è§’åº¦ (104.5 åº¦)
            const angle = 104.5 * (Math.PI / 180);
            const halfAngle = angle / 2;

            // ä¸­å¿ƒæ°§åŸå­ (O)
            const oxygen = new THREE.Mesh(new THREE.SphereGeometry(oxygenRadius, 32, 32), materials.oxygen);
            oxygen.position.set(0, 0, 0);
            oxygen.castShadow = true;
            moleculeGroup.add(oxygen);

            // å…©å€‹æ°«åŸå­ (H) - ä½¿ç”¨ä¸‰è§’å‡½æ•¸è¨ˆç®—ä½ç½®
            // è®“æ°§åŸå­åœ¨ä¸Šæ–¹ (0,0,0)ï¼Œæ°«åŸå­åœ¨ä¸‹æ–¹å…©å´
            const positions = [
                { x: Math.sin(halfAngle) * bondLength, y: -Math.cos(halfAngle) * bondLength }, // å³ä¸‹
                { x: -Math.sin(halfAngle) * bondLength, y: -Math.cos(halfAngle) * bondLength } // å·¦ä¸‹
            ];

            positions.forEach(pos => {
                // å»ºç«‹æ°«åŸå­
                const hydrogen = new THREE.Mesh(new THREE.SphereGeometry(hydrogenRadius, 32, 32), materials.hydrogen);
                hydrogen.position.set(pos.x, pos.y, 0);
                hydrogen.castShadow = true;
                moleculeGroup.add(hydrogen);

                // å»ºç«‹å–®éµ (Cylinder)
                // é€™è£¡éœ€è¦è¨ˆç®—éµçš„ä¸­å¿ƒé»å’Œæ—‹è½‰è§’åº¦ï¼Œæˆ–è€…ç›´æ¥ç”¨æˆ‘å€‘å¯«å¥½çš„ createBond è¼”åŠ©å‡½å¼
                createBond(0, 0, 0, pos.x, pos.y, 0, bondRadius);
            });

            controls.reset();
            camera.position.set(0, 0, 10);
        };

        // --- 3. NaCl æ¨¡å‹ ---
        window.loadNaCl = function() {
            clearScene();

            // UI æ›´æ–°
            updateUI(
                "NaCl æ°¯åŒ–éˆ‰", 
                "é›¢å­æ™¶é«” (Ionic Crystal)", 
                `
                <div class="legend"><span class="dot sodium"></span> éˆ‰é›¢å­ (Naâº)</div>
                <div class="legend"><span class="dot chlorine"></span> æ°¯é›¢å­ (Clâ»)</div>
                `,
                "çµæ§‹: é¢å¿ƒç«‹æ–¹ (FCC)<br>é…ä½æ•¸: 6<br>ç”± Naâº å’Œ Clâ» äº¤éŒ¯æ’åˆ—å½¢æˆç©©å®šçš„æ™¶æ ¼çµæ§‹ã€‚"
            );

            const naRadius = 0.7;
            const clRadius = 1.1;
            const spacing = 2.4;
            const gridSize = 1;
            const bondRadius = 0.08;

            for (let x = -gridSize; x <= gridSize; x++) {
                for (let y = -gridSize; y <= gridSize; y++) {
                    for (let z = -gridSize; z <= gridSize; z++) {
                        const isSodium = (x + y + z) % 2 === 0;
                        const geometry = new THREE.SphereGeometry(isSodium ? naRadius : clRadius, 32, 32);
                        const material = isSodium ? materials.sodium : materials.chlorine;
                        const atom = new THREE.Mesh(geometry, material);
                        atom.position.set(x * spacing, y * spacing, z * spacing);
                        atom.castShadow = true;
                        atom.receiveShadow = true;
                        moleculeGroup.add(atom);

                        if (x < gridSize) createBond(x * spacing, y * spacing, z * spacing, (x + 1) * spacing, y * spacing, z * spacing, bondRadius);
                        if (y < gridSize) createBond(x * spacing, y * spacing, z * spacing, x * spacing, (y + 1) * spacing, z * spacing, bondRadius);
                        if (z < gridSize) createBond(x * spacing, y * spacing, z * spacing, x * spacing, y * spacing, (z + 1) * spacing, bondRadius);
                    }
                }
            }

            moleculeGroup.rotation.x = 0.5;
            moleculeGroup.rotation.y = 0.5;
            controls.reset();
            camera.position.set(0, 0, 16);
        };

        // è¼”åŠ©å‡½å¼: å»ºç«‹å…©é»é–“çš„éµçµ
        function createBond(x1, y1, z1, x2, y2, z2, radius) {
            const start = new THREE.Vector3(x1, y1, z1);
            const end = new THREE.Vector3(x2, y2, z2);
            const distance = start.distanceTo(end);
            
            const geometry = new THREE.CylinderGeometry(radius, radius, distance, 12);
            const bond = new THREE.Mesh(geometry, materials.bond);
            
            const mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
            bond.position.copy(mid);
            bond.lookAt(end);
            bond.rotateX(Math.PI / 2);
            
            moleculeGroup.add(bond);
        }

        // æ›´æ–° UI æ–‡å­—
        function updateUI(title, subtitle, legendHtml, desc) {
            document.getElementById('model-title').innerText = title;
            document.getElementById('model-subtitle').innerText = subtitle;
            document.getElementById('legend-container').innerHTML = legendHtml;
            document.getElementById('model-desc').innerHTML = desc;
        }

        // å…¨åŸŸåˆ‡æ›å‡½å¼
        window.switchModel = function(type) {
            document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${type}`).classList.add('active');

            if (type === 'co2') {
                loadCO2();
            } else if (type === 'nacl') {
                loadNaCl();
            } else if (type === 'h2o') {
                loadH2O();
            }
        };

        // å•Ÿå‹•
        init();

    </script>
</body>
</html>