<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO2 äºŒæ°§åŒ–ç¢³åˆ†å­æ¨¡å‹ (3D Interactive)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #1a1a1a;
            font-family: "Noto Sans TC", sans-serif;
            color: white;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none; /* è®“æ»‘é¼ äº‹ä»¶ç©¿é€åˆ° canvas */
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        h1 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #cccccc;
        }

        .legend {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        .dot.carbon { background-color: #333333; border: 1px solid #555; }
        .dot.oxygen { background-color: #ff3333; border: 1px solid #ff6666; }

        .controls-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            pointer-events: none;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            user-select: none;
        }

        /* Loading indicator */
        #loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: white;
            display: none; /* JS will toggle */
        }
        
        #error-msg {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1rem;
            color: #ff6666;
            text-align: center;
            display: none;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
        }
    </style>
    <!-- Import Map for Three.js -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="ui-layer">
        <h1>COâ‚‚ äºŒæ°§åŒ–ç¢³</h1>
        <div class="legend">
            <span class="dot carbon"></span> ç¢³åŸå­ (Carbon)
        </div>
        <div class="legend">
            <span class="dot oxygen"></span> æ°§åŸå­ (Oxygen)
        </div>
        <p style="margin-top: 10px; font-size: 0.8rem; opacity: 0.8;">
            ç·šæ€§çµæ§‹ (Linear) <br>
            éµè§’: 180Â°
        </p>
    </div>

    <div class="controls-hint">
        ğŸ–±ï¸ æ‹–æ›³ä»¥æ—‹è½‰ | æ»¾è¼ªç¸®æ”¾ | å³éµå¹³ç§»
    </div>

    <div id="loader">è¼‰å…¥æ¨¡å‹ä¸­...</div>
    <div id="error-msg"></div>
    <div id="canvas-container"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. å ´æ™¯è¨­å®š (Scene Setup) ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x1a1a1a); // æ·±è‰²èƒŒæ™¯
        scene.fog = new THREE.Fog(0x1a1a1a, 10, 50);

        // --- 2. ç›¸æ©Ÿè¨­å®š (Camera Setup) ---
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 12);

        // --- 3. æ¸²æŸ“å™¨è¨­å®š (Renderer Setup) - ä¿®æ­£ WebGL éŒ¯èª¤ ---
        let renderer;
        try {
            // æ‰‹å‹•å»ºç«‹ Canvas ä¸¦å˜—è©¦å–å¾— WebGL 1 context (ç›¸å®¹æ€§ä¿®æ­£)
            const canvas = document.createElement('canvas');
            container.appendChild(canvas);

            // å˜—è©¦å–å¾— WebGL 1 contextï¼Œå› ç‚ºæœ‰äº›ç’°å¢ƒç¦æ­¢ WebGL 2
            const contextAttributes = { alpha: true, antialias: true };
            const context = canvas.getContext('webgl', contextAttributes) || canvas.getContext('experimental-webgl', contextAttributes);

            if (!context) {
                throw new Error("ç„¡æ³•å»ºç«‹ WebGL Context");
            }

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                context: context,
                antialias: true, 
                alpha: true 
            });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        } catch (e) {
            console.error("Renderer creation failed:", e);
            const errorDiv = document.getElementById('error-msg');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = "ç„¡æ³•å•Ÿå‹• 3D ç¹ªåœ–å¼•æ“ã€‚<br>åŸå› : " + e.message + "<br>è«‹å˜—è©¦æ›´æ–°ç€è¦½å™¨æˆ–æª¢æŸ¥ç¡¬é«”åŠ é€Ÿè¨­å®šã€‚";
            document.getElementById('loader').style.display = 'none';
        }

        if (renderer) {
            // --- 4. ç‡ˆå…‰è¨­å®š (Lighting) ---
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
            mainLight.position.set(5, 10, 7);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 1024;
            mainLight.shadow.mapSize.height = 1024;
            scene.add(mainLight);

            const fillLight = new THREE.PointLight(0x66ccff, 0.5);
            fillLight.position.set(-10, -5, -5);
            scene.add(fillLight);

            // --- 5. åˆ†å­æ¨¡å‹å»ºæ§‹ (Molecular Model) ---
            const moleculeGroup = new THREE.Group();

            const carbonMaterial = new THREE.MeshPhysicalMaterial({
                color: 0x222222,
                roughness: 0.3,
                metalness: 0.2,
                clearcoat: 0.8,
                clearcoatRoughness: 0.1
            });

            const oxygenMaterial = new THREE.MeshPhysicalMaterial({
                color: 0xe60000,
                roughness: 0.3,
                metalness: 0.1,
                clearcoat: 0.5,
                clearcoatRoughness: 0.1
            });

            const bondMaterial = new THREE.MeshStandardMaterial({
                color: 0xcccccc,
                roughness: 0.4,
                metalness: 0.3
            });

            const carbonRadius = 1.4;
            const oxygenRadius = 1.1;
            const bondLength = 3.5;
            const bondRadius = 0.15;
            const bondOffset = 0.35;

            // ä¸­å¿ƒç¢³åŸå­
            const carbonGeometry = new THREE.SphereGeometry(carbonRadius, 32, 32);
            const carbonAtom = new THREE.Mesh(carbonGeometry, carbonMaterial);
            carbonAtom.castShadow = true;
            carbonAtom.receiveShadow = true;
            moleculeGroup.add(carbonAtom);

            // å»ºç«‹æ°§åŸå­èˆ‡é›™éµ
            function createSide(direction) {
                const xPos = direction * bondLength;

                const oGeo = new THREE.SphereGeometry(oxygenRadius, 32, 32);
                const oxygenAtom = new THREE.Mesh(oGeo, oxygenMaterial);
                oxygenAtom.position.set(xPos, 0, 0);
                oxygenAtom.castShadow = true;
                oxygenAtom.receiveShadow = true;
                moleculeGroup.add(oxygenAtom);

                const cylHeight = bondLength; 
                const cylGeo = new THREE.CylinderGeometry(bondRadius, bondRadius, cylHeight, 16);
                
                const bondTop = new THREE.Mesh(cylGeo, bondMaterial);
                bondTop.rotation.z = Math.PI / 2;
                bondTop.position.set(xPos / 2, bondOffset, 0);
                bondTop.castShadow = true;
                moleculeGroup.add(bondTop);

                const bondBottom = new THREE.Mesh(cylGeo, bondMaterial);
                bondBottom.rotation.z = Math.PI / 2;
                bondBottom.position.set(xPos / 2, -bondOffset, 0);
                bondBottom.castShadow = true;
                moleculeGroup.add(bondBottom);
            }

            createSide(1);
            createSide(-1);

            scene.add(moleculeGroup);

            // --- 6. æ§åˆ¶å™¨ (Controls) ---
            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 20;

            // --- 7. å‹•ç•«è¿´åœˆ (Animation Loop) ---
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }

            animate();

            // --- 8. è¦–çª—èª¿æ•´ (Resize Handler) ---
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            
            // ç§»é™¤è¼‰å…¥æ–‡å­—
            document.getElementById('loader').style.display = 'none';
        }
    </script>
</body>
</html>