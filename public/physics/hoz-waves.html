<!DOCTYPE html>
<html lang="zh-Hant" data-bs-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>疏密波（縱波）模擬 - 國中自然科學模擬動畫</title>
    <meta name="description" content="疏密波(縱波)傳播與質點運動互動式模擬" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
    <style>
        .skip-link{position:absolute;left:-1000px;top:0;background:#000;color:#fff;padding:.5rem 1rem;z-index:1000;} .skip-link:focus{left:0;}
        :focus-visible{outline:3px solid #ff9800;outline-offset:2px;}
        canvas{background:#0d1117;display:block;width:100%;max-width:100%;height:auto;border:1px solid #333;border-radius:4px;}
        .live-region{min-height:1.5em;}
    </style>
</head>
<body class="d-flex flex-column min-vh-100">
    <a href="#main" class="skip-link">跳到主內容</a>
    <!-- Navbar Container -->
    <div id="navbarContainer"></div>
    <main id="main" class="container py-3" tabindex="-1">
        <h1 class="h3 mb-3">疏密波 (縱波) 模擬</h1>
        <p class="mb-4">調整振幅、波長與頻率，觀察縱波密部與疏部傳播，以及質點只在平衡位置附近振盪的特性。</p>
        <div class="row g-4">
            <section class="col-12 col-lg-7" aria-labelledby="sec-visual">
                <h2 id="sec-visual" class="h5">視覺區</h2>
                <div class="ratio ratio-16x9 mb-3">
                    <canvas id="waveCanvas" aria-label="疏密波模擬畫布" role="img"></canvas>
                </div>
                <div id="waveStatus" class="live-region small" aria-live="polite" aria-atomic="true">狀態：運行中</div>
            </section>
            <aside class="col-12 col-lg-5" aria-labelledby="sec-controls">
                <h2 id="sec-controls" class="h5">控制面板</h2>
                <form id="controls" class="needs-validation" novalidate>
                    <fieldset class="mb-3">
                        <legend class="fs-6">參數設定</legend>
                        <div class="mb-3">
                            <label for="amplitudeSlider" class="form-label">振幅 A (px)</label>
                            <input type="range" id="amplitudeSlider" class="form-range" min="5" max="50" value="30" step="1" aria-valuemin="5" aria-valuemax="50" aria-valuenow="30" aria-label="調整振幅">
                            <div class="form-text">質點偏離平衡位置的最大距離。</div>
                        </div>
                        <div class="mb-3">
                            <label for="wavelengthSlider" class="form-label">波長 λ (px)</label>
                            <input type="range" id="wavelengthSlider" class="form-range" min="100" max="500" value="200" step="10" aria-valuemin="100" aria-valuemax="500" aria-valuenow="200" aria-label="調整波長">
                            <div class="form-text">一個密部到下一個密部的距離。</div>
                        </div>
                        <div class="mb-3">
                            <label for="frequencySlider" class="form-label">頻率 f (Hz)</label>
                            <input type="range" id="frequencySlider" class="form-range" min="0.1" max="2" value="0.5" step="0.1" aria-valuemin="0.1" aria-valuemax="2" aria-valuenow="0.5" aria-label="調整頻率">
                            <div class="form-text">質點每秒鐘來回振盪的次數。</div>
                        </div>
                    </fieldset>
                                <div class="btn-group mb-3" role="group" aria-label="模擬控制與說明">
                        <button type="button" id="toggleButton" class="btn btn-primary" aria-pressed="true"><i class="fa-solid fa-pause" aria-hidden="true"></i> 暫停</button>
                        <button type="button" id="resetButton" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate-left" aria-hidden="true"></i> 重設</button>
                                    <button type="button" class="btn btn-outline-info" data-bs-toggle="collapse" data-bs-target="#help" aria-expanded="false" aria-controls="help">
                                        <i class="fa-solid fa-circle-question" aria-hidden="true"></i> 操作說明
                                    </button>
                    </div>
                    <div id="help" class="collapse mt-2">
                        <div class="card card-body small">
                            <strong>快捷鍵：</strong>
                            <ul class="mb-2">
                                <li><kbd>Space</kbd>：播放 / 暫停</li>
                                <li><kbd>R</kbd>：重設</li>
                                <li><kbd>← / →</kbd>：微調振幅</li>
                            </ul>
                            <p class="mb-0">質點只在平衡位置附近振盪，能量與疏密型態沿波的方向傳播。</p>
                        </div>
                    </div>
                </form>
                <div class="alert alert-warning mt-3 small" role="alert">
                    <strong>教學重點：</strong> 紅色質點僅在自身平衡位置振盪，並不前進；傳遞的是能量與擾動。
                </div>
            </aside>
        </div>
    </main>
    <!-- Footer Container -->
    <div id="footerContainer"></div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- ES Module: Load Navigation & Theme -->
    <script type="module">
        import { initThemeToggle } from '../assets/js/theme.js';
        import { loadNavigation } from '../assets/js/navigation.js';
        import { createLiveRegion, KeyboardManager } from '../assets/js/a11y.js';

        // 載入導覽和頁尾
        await loadNavigation({
            baseUrl: '..',
            navbarPath: '../assets/templates/navbar.html',
            footerPath: '../assets/templates/footer.html'
        });

        // 初始化主題切換
        initThemeToggle();

        // 建立 Live Region
        window.liveRegion = createLiveRegion({ id: 'waveStatus', throttle: 300 });

        // 鍵盤快捷鍵
        const keyboardManager = new KeyboardManager();
        keyboardManager.register(' ', () => {
            document.getElementById('toggleButton').click();
        }, { description: '播放/暫停' });
        keyboardManager.register('r', () => {
            document.getElementById('resetButton').click();
        }, { description: '重設' });
        keyboardManager.register('ArrowLeft', () => {
            const amplitudeSlider = document.getElementById('amplitudeSlider');
            amplitudeSlider.stepDown();
            amplitudeSlider.dispatchEvent(new Event('input'));
        }, { description: '微調振幅左' });
        keyboardManager.register('ArrowRight', () => {
            const amplitudeSlider = document.getElementById('amplitudeSlider');
            amplitudeSlider.stepUp();
            amplitudeSlider.dispatchEvent(new Event('input'));
        }, { description: '微調振幅右' });
    </script>
    <!-- Page-Specific Simulation Logic -->
    <script>
        // 原縱波模擬程式碼
        // 保持 window.onload 以確保 DOM 元素已載入
        window.onload = function() {
            // 初始設定
            const canvas = document.getElementById('waveCanvas');
            const ctx = canvas.getContext('2d');
            // 取得所有控制元件
            const amplitudeSlider = document.getElementById('amplitudeSlider');
            const wavelengthSlider = document.getElementById('wavelengthSlider');
            const frequencySlider = document.getElementById('frequencySlider');
            const toggleButton = document.getElementById('toggleButton');
            const resetButton = document.getElementById('resetButton');
            const statusRegion = document.getElementById('waveStatus');
            // 畫布基本設定
            canvas.width = 800; // 固定畫布解析度
            canvas.height = 200;
            // 質點設定
            const NUM_PARTICLES = 60;
            const PARTICLE_WIDTH = 8;
            const PARTICLE_HEIGHT = 80;
            const particles = [];
            const HIGHLIGHT_INDEX = Math.floor(NUM_PARTICLES / 4);
            let time = 0;
            let isRunning = true;
            let amplitude, wavelength, frequency, k, w;
            function setupParticles() {
                particles.length = 0;
                const spacing = canvas.width / (NUM_PARTICLES + 1);
                for (let i = 0; i < NUM_PARTICLES; i++) {
                    const x_eq = spacing * (i + 1);
                    const y = canvas.height / 2;
                    particles.push({
                        x_eq: x_eq,
                        y: y,
                        x: x_eq,
                        isHighlighted: (i === HIGHLIGHT_INDEX)
                    });
                }
            }
            function readParameters() {
                amplitude = parseFloat(amplitudeSlider.value);
                wavelength = parseFloat(wavelengthSlider.value);
                frequency = parseFloat(frequencySlider.value);
                k = (2 * Math.PI) / wavelength;
                w = (2 * Math.PI) * frequency;
            }
            function update() {
                if (!isRunning) return;
                readParameters();
                time += 0.016;
                particles.forEach(p => {
                    const displacement = amplitude * Math.sin(k * p.x_eq - w * time);
                    p.x = p.x_eq + displacement;
                });
            }
            function draw() {
                ctx.fillStyle = '#111827';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    if (p.isHighlighted) {
                        ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(p.x_eq, p.y - 40);
                        ctx.lineTo(p.x_eq, p.y + 40);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                    ctx.beginPath();
                    ctx.fillStyle = p.isHighlighted ? '#ef4444' : '#ffffff';
                    ctx.fillRect(p.x - PARTICLE_WIDTH / 2, p.y - PARTICLE_HEIGHT / 2, PARTICLE_WIDTH, PARTICLE_HEIGHT);
                });
            }
            function animateLoop() {
                update();
                draw();
                if (isRunning) {requestAnimationFrame(animateLoop);}
            }
            toggleButton.addEventListener('click', () => {
                isRunning = !isRunning;
                toggleButton.innerHTML = isRunning ? '<i class="fa-solid fa-pause" aria-hidden="true"></i> 暫停' : '<i class="fa-solid fa-play" aria-hidden="true"></i> 播放';
                toggleButton.setAttribute('aria-pressed', isRunning);
                statusRegion.textContent = '狀態：' + (isRunning ? '運行中' : '已暫停');
                if (isRunning) {animateLoop();}
            });
            resetButton.addEventListener('click', () => {
                time = 0;
                amplitudeSlider.value = 30;
                wavelengthSlider.value = 200;
                frequencySlider.value = 0.5;
                readParameters();
                particles.forEach(p => {
                    const displacement = amplitude * Math.sin(k * p.x_eq - w * time);
                    p.x = p.x_eq + displacement;
                });
                draw();
                statusRegion.textContent = '狀態：已重設';
            });
            function handleSliderChange() {
                readParameters();
                if (!isRunning) {
                    particles.forEach(p => {
                        const displacement = amplitude * Math.sin(k * p.x_eq - w * time);
                        p.x = p.x_eq + displacement;
                    });
                    draw();
                }
            }
            amplitudeSlider.addEventListener('input', handleSliderChange);
            wavelengthSlider.addEventListener('input', handleSliderChange);
            frequencySlider.addEventListener('input', handleSliderChange);
            document.addEventListener('keydown',(e)=>{if(e.code==='Space'){e.preventDefault();toggleButton.click();} if(e.key==='R'){resetButton.click();} if(e.key==='ArrowLeft'){amplitudeSlider.stepDown(); handleSliderChange();} if(e.key==='ArrowRight'){amplitudeSlider.stepUp(); handleSliderChange();}});
            setupParticles();
            readParameters();
            animateLoop();
        };
    </script>
</body>
</html>